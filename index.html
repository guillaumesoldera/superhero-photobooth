<html>
    <head>
        <style>
            .main-container {
                position: relative;
            }

            #overlay {
                position: absolute;
                top: 0;
                left: 0;
            }
        </style>
        <script>
            const sizings = {
                'mask-bleu': {
                    topOffset: -90,
                    leftOffet: -60,
                    widthOffset: 130,
                    heightOffset: 130
                },
                'iron-man': {
                    topOffset: -70,
                    leftOffet: -40,
                    widthOffset: 70,
                    heightOffset: 70
                },
                'wolverine': {
                    topOffset: -95,
                    leftOffet: -40,
                    widthOffset: 80,
                    heightOffset: 120
                },
                'spiderman': {
                    topOffset: -75,
                    leftOffet: -15,
                    widthOffset: 40,
                    heightOffset: 40
                },
                'batman': {
                    topOffset: -100,
                    leftOffet: -20,
                    widthOffset: 45,
                    heightOffset: 45
                },
                'diademe': {
                    topOffset: -80,
                    leftOffet: -35,
                    widthOffset: 80,
                    heightOffset: 80
                },
                'flash': {
                    topOffset: -75,
                    leftOffet: -30,
                    widthOffset: 60,
                    heightOffset: 60
                }
            }
            let hero = 'flash';
            const maskImage = new Image();
            //maskImage.src = './assets/images/mask-bleu.png';
            maskImage.src = `./assets/images/${hero}.png`;
            let sizing = sizings[hero]
            function onFaceApiLoad() {
                console.log(faceapi.nets)
                // return faceapi.nets.ssdMobilenetv1.loadFromUri('./assets/models')
                // return faceapi.nets.tinyFaceDetector.loadFromUri('./assets/models')
                return getCurrentFaceDetectionNet().loadFromUri('./assets/models').then(() => {
                    faceapi.nets.faceLandmark68TinyNet.loadFromUri('./assets/models')
                })
            }

            function isFaceDetectionModelLoaded() {
               return !!getCurrentFaceDetectionNet().params
            }

            function getCurrentFaceDetectionNet() {
                // return faceapi.nets.ssdMobilenetv1
                return faceapi.nets.tinyFaceDetector
                // return faceapi.nets.faceLandmark68TinyNet
            }

            async function onPlay() {
                const videoEl = document.getElementById('inputVideo')

                if(videoEl.paused || videoEl.ended || !isFaceDetectionModelLoaded()) {
                    console.log('not loaded')
                    return setTimeout(() => onPlay())
                }


                // const options = getFaceDetectorOptions()
                // const options = new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 })
                let inputSize = 512
                let scoreThreshold = 0.5
                const options = new faceapi.TinyFaceDetectorOptions({ inputSize, scoreThreshold })

                const ts = Date.now()
                const result = await faceapi.detectSingleFace(videoEl, options).withFaceLandmarks(true)
                //const result = await faceapi.detectSingleFace(videoEl, options)
                //updateTimeStats(Date.now() - ts)

                if (result) {
                    const canvas = document.getElementById('overlay')
                    const dims = faceapi.matchDimensions(canvas, videoEl, true)
                    const height = dims.height
                    const width =  dims.width
                    const resizedResults = faceapi.resizeResults(result, dims);
                    const box = resizedResults.box || resizedResults.detection.box;
                    const top = box.top + sizing.topOffset;
                    
                    // box.right
                    //const left = box.left - 60;
                    const left = box.left + sizing.leftOffet;
                    // box.bottom
                    //const boxWidth = box.width + 130;
                    const boxWidth = box.width + sizing.widthOffset;
                    //const boxHeight = box.height + 160;
                    const boxHeight = box.height + sizing.heightOffset;
                    
                    //faceapi.draw.drawDetections(canvas, resizedResults);
                    const ctx = canvas.getContext('2d');                    
                    ctx.drawImage(maskImage, left, top, boxWidth, boxHeight);
                    // TODO regarder la position du nez pour voir si c'est au milieu de la box (avec box.width et box.height)
                    // suivant la distance entre le nez et le milieu de la boite, faire un rotate3d
                    if (result.landmarks) {
                        const leftEye = result.landmarks.getLeftEye()[0]
                        const rightEye = result.landmarks.getRightEye()[0]
                        const angle = Math.atan2(rightEye.y - leftEye.y, rightEye.x - leftEye.x) * 180 / Math.PI;
                        canvas.style.transform = `rotate(${angle}deg)`;
                    }
                }

                setTimeout(() => onPlay())
            }

            async function setVideo() {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} })
                const videoEl = document.getElementById('inputVideo')
                videoEl.srcObject = stream
            }

            function run() {
                onFaceApiLoad()
                .then(() => {
                    setVideo();
                })
            }   
            function selectMask(option) {
                hero = option.value;
                maskImage.src = `./assets/images/${hero}.png`;
                sizing = sizings[hero]
            }

        </script>
        <script src="./scripts/face-api.min.js" onload="run()"></script>
    </head>
    <body>
        <header>
            <h1>Become a superhero !</h1>
        </header>
        <main>
            <div class="main-container">
                <video onloadedmetadata="onPlay(this)" id="inputVideo" autoplay muted playsinline></video>
                <canvas id="overlay" />
            </div>
            <select onchange="selectMask(this.options[this.selectedIndex])">
                <option value="batman">Batman</option>
                <option value="diademe">Diadème</option>
                <option value="iron-man" >Iron Man</option>
                <option value="mask-bleu">Masque Bleu</option>
                <option value="spiderman">Spiderman</option>
                <option value="wolverine">Wolverine</option>
                <option value="flash" selected>Flash</option>
            </select>
        </main>
    </body>
</html>