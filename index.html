<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, shrink-to-fit=no">
        <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Bangers" />
        <link rel="manifest" href="/manifest.json">
        <link rel="stylesheet" type="text/css" href="./stylesheets/style.css" />
        <link rel="shortcut icon" type="image/png" href="/assets/images/icons/icon-72x72.png">
        <link rel="icon" sizes="192x192" href="/assets/images/icons/icon-192x192.png">
        <link rel="apple-touch-icon" href="/assets/images/icons/icon-128x128.png">
        <link rel="apple-touch-icon" sizes="192x192" href="/assets/images/icons/icon-192x192.png">
        <link rel="apple-touch-startup-image" href="/assets/images/icons/icon-192x192.png">

        <script>
            let vh = window.innerHeight * 0.01;
            // Then we set the value in the --vh custom property to the root of the document
            document.documentElement.style.setProperty('--vh', `${vh}px`);
            if('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js');
            };
        </script>
    </head>
    <body>
        <header>
            <h1>You are a superhero !</h1>
        </header>
        <main>
            <div class="switch-cameras-container">
                <select id="switch-cameras" onchange="selectCamera(this.options[this.selectedIndex])" style="display: none;">
                    <option value="user">Front</option>
                    <option value="environment">Back</option>
                </select>
            </div>
            <div class="main-container">
                <div class="video-container">
                    <video class="box sheet" onloadedmetadata="onPlay(this)" id="inputVideo" autoplay muted playsinline></video>
                    <canvas id="overlay" />
                </div>
            </div>
            <select class="box mask-select" onchange="selectMask(this.options[this.selectedIndex])">
                <option value="batman">Batman</option>
                <option value="diademe">Diadème argent</option>
                <option value="iron-man" >Iron Man</option>
                <option value="mask-bleu">Masque Bleu</option>
                <option value="spiderman">Spiderman</option>
                <option value="wolverine">Wolverine</option>
                <option value="flash">Flash</option>
                <option value="mask-vert">Masque vert</option>
                <option value="diademe-2">Diadème or</option>
                <option value="mask-rouge">Masque rouge</option>
                <option value="mask-catcheur" selected>Masque catcheur</option>
            </select>
            <button type="button" class="box mask-random" onclick="randomMask()">
                Au hasard !
            </button>
        </main>

        <script>
            const videoEl = document.getElementById('inputVideo')
            const sizings = {
                'mask-bleu': {
                    topOffset: -90,
                    leftOffet: -60,
                    widthOffset: 130,
                    heightOffset: 130
                },
                'iron-man': {
                    topOffset: -70,
                    leftOffet: -40,
                    widthOffset: 70,
                    heightOffset: 70
                },
                'wolverine': {
                    topOffset: -95,
                    leftOffet: -40,
                    widthOffset: 80,
                    heightOffset: 120
                },
                'spiderman': {
                    topOffset: -75,
                    leftOffet: -15,
                    widthOffset: 40,
                    heightOffset: 40
                },
                'batman': {
                    topOffset: -100,
                    leftOffet: -20,
                    widthOffset: 45,
                    heightOffset: 45
                },
                'diademe': {
                    topOffset: -80,
                    leftOffet: -35,
                    widthOffset: 80,
                    heightOffset: 80
                },
                'diademe-2': {
                    topOffset: -80,
                    leftOffet: -35,
                    widthOffset: 80,
                    heightOffset: 80
                },
                'flash': {
                    topOffset: -75,
                    leftOffet: -30,
                    widthOffset: 60,
                    heightOffset: 60
                },
                'mask-vert': {
                    topOffset: -40,
                    leftOffet: -5,
                    widthOffset: 10,
                    heightOffset: 10
                },
                'mask-rouge': {
                    topOffset: -65,
                    leftOffet: -30,
                    widthOffset: 50,
                    heightOffset: 50
                },
                'mask-catcheur': {
                    topOffset: -65,
                    leftOffet: -30,
                    widthOffset: 70,
                    heightOffset: 70
                }
            }
            let hero = 'mask-catcheur';
            const maskImage = new Image();
            //maskImage.src = './assets/images/mask-bleu.png';
            maskImage.src = `./assets/images/${hero}.png`;
            let sizing = sizings[hero]
            function onFaceApiLoad() {
                console.log(faceapi.nets)
                // return faceapi.nets.ssdMobilenetv1.loadFromUri('./assets/models')
                // return faceapi.nets.tinyFaceDetector.loadFromUri('./assets/models')
                return getCurrentFaceDetectionNet().loadFromUri('./assets/models').then(() => {
                    faceapi.nets.faceLandmark68TinyNet.loadFromUri('./assets/models')
                })
            }

            function isFaceDetectionModelLoaded() {
               return !!getCurrentFaceDetectionNet().params
            }

            function getCurrentFaceDetectionNet() {
                // return faceapi.nets.ssdMobilenetv1
                return faceapi.nets.tinyFaceDetector
                // return faceapi.nets.faceLandmark68TinyNet
            }

            async function onPlay() {

                if (videoEl.paused || videoEl.ended || !isFaceDetectionModelLoaded()) {
                    console.log('not loaded')
                    return requestAnimationFrame(() => onPlay())
                }


                // const options = getFaceDetectorOptions()
                // const options = new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 })
                let inputSize = 512
                let scoreThreshold = 0.5
                const options = new faceapi.TinyFaceDetectorOptions({ inputSize, scoreThreshold })

                const ts = Date.now()
                const result = await faceapi.detectSingleFace(videoEl, options).withFaceLandmarks(true)
                //const result = await faceapi.detectSingleFace(videoEl, options)
                //updateTimeStats(Date.now() - ts)
                const canvas = document.getElementById('overlay')
                const ctx = canvas.getContext('2d');  
                if (result) {
                    const dims = faceapi.matchDimensions(canvas, videoEl, true)
                    const height = dims.height
                    const width =  dims.width
                    const resizedResults = faceapi.resizeResults(result, dims);
                    const box = resizedResults.box || resizedResults.detection.box;
                    const top = box.top + sizing.topOffset;
                    
                    // box.right
                    //const left = box.left - 60;
                    const left = box.left + sizing.leftOffet;
                    // box.bottom
                    //const boxWidth = box.width + 130;
                    const boxWidth = box.width + sizing.widthOffset;
                    //const boxHeight = box.height + 160;
                    const boxHeight = box.height + sizing.heightOffset;
                    
                    //faceapi.draw.drawDetections(canvas, resizedResults);
                                      
                    ctx.drawImage(maskImage, left, top, boxWidth, boxHeight);
                    // TODO regarder la position du nez pour voir si c'est au milieu de la box (avec box.width et box.height)
                    // suivant la distance entre le nez et le milieu de la boite, faire un rotate3d
                    if (result.landmarks) {
                        const leftEye = result.landmarks.getLeftEye()[0]
                        const rightEye = result.landmarks.getRightEye()[0]
                        const angle = Math.atan2(rightEye.y - leftEye.y, rightEye.x - leftEye.x) * 180 / Math.PI;
                        canvas.style.transform = `rotate(${angle}deg)`;
                    }
                } else {
                    // marche pas trop
                    //ctx.clearRect(0, 0, canvas.width, canvas.height);
                }

                requestAnimationFrame(() => onPlay())
            }

            async function setVideo() {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} })
                videoEl.srcObject = stream
            }

            function run() {
                hasManyCameras()
                .then(hasMany => {
                    if (hasMany) {
                        document.getElementById('switch-cameras').style = "";
                    }
                })
                onFaceApiLoad()
                .then(() => {
                    selectCamera()
                })
            }   
            function selectMask(option) {
                hero = option.value;
                maskImage.src = `./assets/images/${hero}.png`;
                sizing = sizings[hero]
            }

            function hasManyCameras() {
                if (navigator.mediaDevices) {
                    return navigator.mediaDevices.enumerateDevices()
                        .then(devices => {
                            return devices.filter(mediaDevice => mediaDevice.kind === 'videoinput') .length > 1
                        });
                }
                return Promise.resolve(false)
            }

            let _currentStream = undefined;

            function stopMediaTracks(stream) {
                stream.getTracks().forEach(track => {
                    track.stop();
                });
            }

            async function selectCamera(option) {
                if (_currentStream) {
                    stopMediaTracks(_currentStream);
                }

                const videoConstraints = option ? {
                    facingMode: option.value
                } : {};
                const constraints = {
                    video: videoConstraints,
                    audio: false
                };
                const stream = await navigator.mediaDevices.getUserMedia(constraints)
                _currentStream = stream;
                videoEl.srcObject = stream;
                    
            }

            function randomMask() {
                const heroes = Object.keys(sizings);
                hero = heroes[Math.floor(Math.random() * heroes.length)];
                maskImage.src = `./assets/images/${hero}.png`;
                sizing = sizings[hero]
            }

        </script>
        <script src="./scripts/face-api.min.js" onload="run()"></script>
    </body>
</html>